{% extends "base.html" %}

{% block title %}Book Appointment - MediBook{% endblock %}

{% block content %}
<div class="container page-spacer" style="max-width: 1000px;">
    <!-- Two Column Layout matching the image -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;">

        <!-- LEFT COLUMN: Calendar & Time -->
        <div class="card-dark">
            <h2 style="margin-bottom: 2rem;">Select Date</h2>

            <!-- Custom Calendar -->
            <div id="customCalendar">
                <div class="calendar-header">
                    <button type="button" class="calendar-nav-btn" id="prevMonth">← Prev</button>
                    <h3 id="currentMonthLabel">January 2026</h3>
                    <button type="button" class="calendar-nav-btn" id="nextMonth">Next →</button>
                </div>

                <div class="calendar-grid">
                    <div class="calendar-day-header">SUN</div>
                    <div class="calendar-day-header">MON</div>
                    <div class="calendar-day-header">TUE</div>
                    <div class="calendar-day-header">WED</div>
                    <div class="calendar-day-header">THU</div>
                    <div class="calendar-day-header">FRI</div>
                    <div class="calendar-day-header">SAT</div>
                    <!-- Days generated by JS -->
                </div>
                <div id="calendarDays" class="calendar-grid" style="margin-bottom: 0;"></div>
            </div>

            <h2 style="margin-top: 3rem; margin-bottom: 1.5rem;">Select Time</h2>
            <div id="selectedDateLabel"
                style="color: #A0AEC0; text-align: center; margin-bottom: 1.5rem; font-size: 0.9rem;">
                Select a date to view available times
            </div>

            <div id="timeSlotsContainer" class="time-grid">
                <!-- Time slots generated by JS -->
            </div>
        </div>

        <!-- RIGHT COLUMN: User Info Form -->
        <div class="card-dark">
            <h2 style="margin-bottom: 2rem;">Your Information</h2>

            <form method="POST" id="bookingForm">
                <!-- Hidden inputs for logic -->
                <input type="hidden" name="date" id="dateInput" required>
                <input type="hidden" name="time" id="timeInput" required>

                <div class="form-group-dark">
                    <label>Full Name *</label>
                    <input type="text" class="form-control-dark" value="{{ current_user.name }}" readonly
                        style="opacity: 0.7; cursor: not-allowed;">
                </div>

                <div class="form-group-dark">
                    <label>Email *</label>
                    <input type="email" class="form-control-dark" value="{{ current_user.email }}" readonly
                        style="opacity: 0.7; cursor: not-allowed;">
                </div>

                <div class="form-group-dark">
                    <label>Phone Number *</label>
                    <input type="tel" class="form-control-dark" value="{{ current_user.phone_number or '' }}" readonly
                        style="opacity: 0.7; cursor: not-allowed;">
                </div>

                <div class="form-group-dark">
                    <label>Preferred Doctor (Optional)</label>
                    <div class="form-control-dark" style="opacity: 0.7;">Dr. {{ doctor.user.name }} ({{
                        doctor.specialization }})</div>
                </div>

                <div class="form-group-dark">
                    <label>Consultation Type</label>
                    <select name="type" class="form-control-dark">
                        <option value="online">Online Video Call</option>
                        <option value="physical">In-Person Visit</option>
                    </select>
                </div>

                <div class="form-group-dark">
                    <label>Reason for Visit</label>
                    <textarea name="notes" class="form-control-dark" rows="4"
                        placeholder="Briefly describe your concern..."></textarea>
                </div>

                <button type="submit" class="btn-accent" id="submitBtn" disabled>Request Appointment</button>
            </form>
        </div>
    </div>
</div>

<script>
    const doctorId = "{{ doctor.id }}";
    let currentDate = new Date(); // Start at current date
    let selectedDate = null;
    let selectedTime = null;

    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('currentMonthLabel').textContent = `${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1).getDay(); // Day of week 0-6
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const grid = document.getElementById('calendarDays');
        grid.innerHTML = '';

        // Empty slots for previous month
        for (let i = 0; i < firstDay; i++) {
            const empty = document.createElement('div');
            grid.appendChild(empty);
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let d = 1; d <= daysInMonth; d++) {
            const btn = document.createElement('div');
            btn.className = 'calendar-day';
            btn.textContent = d;

            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const checkDate = new Date(year, month, d);

            // Disable past dates
            if (checkDate < today) {
                btn.classList.add('disabled');
            } else {
                btn.onclick = () => selectDate(dateStr, btn);
            }

            // Highlight selected
            if (selectedDate === dateStr) {
                btn.classList.add('selected');
            }

            grid.appendChild(btn);
        }
    }

    function selectDate(dateStr, btnElement) {
        selectedDate = dateStr;
        document.getElementById('dateInput').value = dateStr;

        // Visual update
        document.querySelectorAll('.calendar-day').forEach(b => b.classList.remove('selected'));
        if (btnElement) btnElement.classList.add('selected');

        // Update Label
        const d = new Date(dateStr);
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('selectedDateLabel').textContent = d.toLocaleDateString('en-US', options);

        loadSlots(dateStr);
    }

    function loadSlots(dateStr) {
        const container = document.getElementById('timeSlotsContainer');
        container.innerHTML = '<p style="color: #A0AEC0; grid-column: 1/-1; text-align: center;">Loading slots...</p>';
        document.getElementById('submitBtn').disabled = true;

        fetch(`/api/slots/${doctorId}?date=${dateStr}`)
            .then(res => res.json())
            .then(slots => {
                container.innerHTML = '';
                if (slots.length === 0) {
                    container.innerHTML = '<p style="color: #FC8181; grid-column: 1/-1; text-align: center;">No slots available.</p>';
                    return;
                }

                slots.forEach(slot => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'time-slot-btn';
                    btn.textContent = slot.time;
                    btn.disabled = !slot.available;

                    if (slot.available) {
                        btn.onclick = () => selectTime(slot.time, btn);
                    }

                    container.appendChild(btn);
                });
            })
            .catch(err => {
                console.error(err);
                container.innerHTML = '<p style="color: #FC8181; grid-column: 1/-1; text-align: center;">Error loading slots.</p>';
            });
    }

    function selectTime(time, btnElement) {
        selectedTime = time;
        document.getElementById('timeInput').value = time;

        document.querySelectorAll('.time-slot-btn').forEach(b => b.classList.remove('selected'));
        btnElement.classList.add('selected');

        document.getElementById('submitBtn').disabled = false;
    }

    // Navigation Events
    document.getElementById('prevMonth').onclick = () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    };
    document.getElementById('nextMonth').onclick = () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    };

    // Initial Render
    renderCalendar();
</script>

<!-- Mobile Responsive Tweak -->
<style>
    @media (max-width: 768px) {
        div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}